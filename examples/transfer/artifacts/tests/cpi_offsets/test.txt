#[test]
fn test_cpi_offsets() {
    #[repr(C)]
    struct SolInstruction {
        program_id_addr: u64,
        accounts_addr: u64,
        accounts_len: u64,
        data_addr: u64,
        data_len: u64,
    }

    #[repr(C)]
    struct SolAccountMeta {
        pubkey_addr: u64,
        is_writable: bool,
        is_signer: bool,
        padding: [u8; 6],
    }

    #[repr(C)]
    struct SolAccountInfo {
        key_addr: u64,
        lamports_addr: u64,
        data_len: u64,
        data_addr: u64,
        owner_addr: u64,
        rent_epoch: u64,
        is_signer: bool,
        is_writable: bool,
        executable: bool,
        padding: [u8; 5],
    }

    #[repr(C)]
    struct InstructionData {
        variant: [u8; 4],
        amount: [u8; 8],
        padding: [u8; 4],
    }

    // CPI instruction offsets.
    const CPI_INSN_PROGRAM_ID_ADDR_OFFSET: usize = 0;
    const CPI_INSN_ACCOUNTS_ADDR_OFFSET: usize = 8;
    const CPI_INSN_ACCOUNTS_LEN_OFFSET: usize = 16;
    const CPI_INSN_DATA_ADDR_OFFSET: usize = 24;
    const CPI_INSN_DATA_LEN_OFFSET: usize = 32;

    // CPI account meta offsets.
    const CPI_ACCT_META_PUBKEY_ADDR_OFFSET: usize = 0;
    const CPI_ACCT_META_IS_WRITABLE_OFFSET: usize = 8;
    const CPI_ACCT_META_IS_SIGNER_OFFSET: usize = 9;
    const CPI_ACCT_META_SIZE_OF: usize = 16;

    // CPI account meta offsets for recipient.
    const CPI_ACCT_META_PUBKEY_ADDR_RECIPIENT_OFFSET: usize = 16;
    const CPI_ACCT_META_IS_WRITABLE_RECIPIENT_OFFSET: usize = 24;
    const CPI_ACCT_META_IS_SIGNER_RECIPIENT_OFFSET: usize = 25;

    // CPI account info offsets.
    const CPI_ACCT_INFO_KEY_ADDR_OFFSET: usize = 0;
    const CPI_ACCT_INFO_LAMPORTS_ADDR_OFFSET: usize = 8;
    const CPI_ACCT_INFO_DATA_LEN_OFFSET: usize = 16;
    const CPI_ACCT_INFO_DATA_ADDR_OFFSET: usize = 24;
    const CPI_ACCT_INFO_OWNER_ADDR_OFFSET: usize = 32;
    const CPI_ACCT_INFO_RENT_EPOCH_OFFSET: usize = 40;
    const CPI_ACCT_INFO_IS_SIGNER_OFFSET: usize = 48;
    const CPI_ACCT_INFO_IS_WRITABLE_OFFSET: usize = 49;
    const CPI_ACCT_INFO_EXECUTABLE_OFFSET: usize = 50;
    const CPI_ACCT_INFO_SIZE_OF: usize = 56;

    // CPI account info offsets for recipient.
    const CPI_ACCT_INFO_KEY_ADDR_RECIPIENT_OFFSET: usize = 56;
    const CPI_ACCT_INFO_LAMPORTS_ADDR_RECIPIENT_OFFSET: usize = 64;
    const CPI_ACCT_INFO_DATA_LEN_RECIPIENT_OFFSET: usize = 72;
    const CPI_ACCT_INFO_DATA_ADDR_RECIPIENT_OFFSET: usize = 80;
    const CPI_ACCT_INFO_OWNER_ADDR_RECIPIENT_OFFSET: usize = 88;
    const CPI_ACCT_INFO_RENT_EPOCH_RECIPIENT_OFFSET: usize = 96;
    const CPI_ACCT_INFO_IS_SIGNER_RECIPIENT_OFFSET: usize = 104;
    const CPI_ACCT_INFO_IS_WRITABLE_RECIPIENT_OFFSET: usize = 105;
    const CPI_ACCT_INFO_EXECUTABLE_RECIPIENT_OFFSET: usize = 106;

    // CPI instruction data offsets.
    const CPI_INSN_DATA_VARIANT_OFFSET: usize = 0;
    const CPI_INSN_DATA_AMOUNT_OFFSET: usize = 4;
    const CPI_INSN_DATA_LEN: usize = 12;

    // Stack offsets.
    const STACK_INSN_OFFSET: usize = 200;
    const STACK_INSN_DATA_OFFSET: usize = 160;
    const STACK_ACCT_METAS_OFFSET: usize = 144;
    const STACK_ACCT_INFOS_OFFSET: usize = 112;

    // CPI instruction checks.
    assert_eq!(
        CPI_INSN_PROGRAM_ID_ADDR_OFFSET,
        offset_of!(SolInstruction, program_id_addr)
    );
    assert_eq!(
        CPI_INSN_ACCOUNTS_ADDR_OFFSET,
        offset_of!(SolInstruction, accounts_addr)
    );
    assert_eq!(
        CPI_INSN_ACCOUNTS_LEN_OFFSET,
        offset_of!(SolInstruction, accounts_len)
    );
    assert_eq!(
        CPI_INSN_DATA_ADDR_OFFSET,
        offset_of!(SolInstruction, data_addr)
    );
    assert_eq!(
        CPI_INSN_DATA_LEN_OFFSET,
        offset_of!(SolInstruction, data_len)
    );

    // CPI account meta checks.
    assert_eq!(
        CPI_ACCT_META_PUBKEY_ADDR_OFFSET,
        offset_of!(SolAccountMeta, pubkey_addr)
    );
    assert_eq!(
        CPI_ACCT_META_IS_WRITABLE_OFFSET,
        offset_of!(SolAccountMeta, is_writable)
    );
    assert_eq!(
        CPI_ACCT_META_IS_SIGNER_OFFSET,
        offset_of!(SolAccountMeta, is_signer)
    );
    assert!(size_of::<SolAccountMeta>().is_multiple_of(ALIGNMENT));
    assert_eq!(CPI_ACCT_META_SIZE_OF, size_of::<SolAccountMeta>());

    // CPI account meta checks for recipient.
    assert_eq!(
        CPI_ACCT_META_PUBKEY_ADDR_RECIPIENT_OFFSET,
        CPI_ACCT_META_SIZE_OF + offset_of!(SolAccountMeta, pubkey_addr)
    );
    assert_eq!(
        CPI_ACCT_META_IS_WRITABLE_RECIPIENT_OFFSET,
        CPI_ACCT_META_SIZE_OF + offset_of!(SolAccountMeta, is_writable)
    );
    assert_eq!(
        CPI_ACCT_META_IS_SIGNER_RECIPIENT_OFFSET,
        CPI_ACCT_META_SIZE_OF + offset_of!(SolAccountMeta, is_signer)
    );

    // CPI account info checks.
    assert_eq!(
        CPI_ACCT_INFO_KEY_ADDR_OFFSET,
        offset_of!(SolAccountInfo, key_addr)
    );
    assert_eq!(
        CPI_ACCT_INFO_LAMPORTS_ADDR_OFFSET,
        offset_of!(SolAccountInfo, lamports_addr)
    );
    assert_eq!(
        CPI_ACCT_INFO_DATA_LEN_OFFSET,
        offset_of!(SolAccountInfo, data_len)
    );
    assert_eq!(
        CPI_ACCT_INFO_DATA_ADDR_OFFSET,
        offset_of!(SolAccountInfo, data_addr)
    );
    assert_eq!(
        CPI_ACCT_INFO_OWNER_ADDR_OFFSET,
        offset_of!(SolAccountInfo, owner_addr)
    );
    assert_eq!(
        CPI_ACCT_INFO_RENT_EPOCH_OFFSET,
        offset_of!(SolAccountInfo, rent_epoch)
    );
    assert_eq!(
        CPI_ACCT_INFO_IS_SIGNER_OFFSET,
        offset_of!(SolAccountInfo, is_signer)
    );
    assert_eq!(
        CPI_ACCT_INFO_IS_WRITABLE_OFFSET,
        offset_of!(SolAccountInfo, is_writable)
    );
    assert_eq!(
        CPI_ACCT_INFO_EXECUTABLE_OFFSET,
        offset_of!(SolAccountInfo, executable)
    );
    assert_eq!(CPI_ACCT_INFO_SIZE_OF, size_of::<SolAccountInfo>());
    assert!(size_of::<SolAccountMeta>().is_multiple_of(ALIGNMENT));

    // CPI account info checks for recipient.
    assert_eq!(
        CPI_ACCT_INFO_KEY_ADDR_RECIPIENT_OFFSET,
        CPI_ACCT_INFO_SIZE_OF + offset_of!(SolAccountInfo, key_addr)
    );
    assert_eq!(
        CPI_ACCT_INFO_LAMPORTS_ADDR_RECIPIENT_OFFSET,
        CPI_ACCT_INFO_SIZE_OF + offset_of!(SolAccountInfo, lamports_addr)
    );
    assert_eq!(
        CPI_ACCT_INFO_DATA_LEN_RECIPIENT_OFFSET,
        CPI_ACCT_INFO_SIZE_OF + offset_of!(SolAccountInfo, data_len)
    );
    assert_eq!(
        CPI_ACCT_INFO_DATA_ADDR_RECIPIENT_OFFSET,
        CPI_ACCT_INFO_SIZE_OF + offset_of!(SolAccountInfo, data_addr)
    );
    assert_eq!(
        CPI_ACCT_INFO_OWNER_ADDR_RECIPIENT_OFFSET,
        CPI_ACCT_INFO_SIZE_OF + offset_of!(SolAccountInfo, owner_addr)
    );
    assert_eq!(
        CPI_ACCT_INFO_RENT_EPOCH_RECIPIENT_OFFSET,
        CPI_ACCT_INFO_SIZE_OF + offset_of!(SolAccountInfo, rent_epoch)
    );
    assert_eq!(
        CPI_ACCT_INFO_IS_SIGNER_RECIPIENT_OFFSET,
        CPI_ACCT_INFO_SIZE_OF + offset_of!(SolAccountInfo, is_signer)
    );
    assert_eq!(
        CPI_ACCT_INFO_IS_WRITABLE_RECIPIENT_OFFSET,
        CPI_ACCT_INFO_SIZE_OF + offset_of!(SolAccountInfo, is_writable)
    );
    assert_eq!(
        CPI_ACCT_INFO_EXECUTABLE_RECIPIENT_OFFSET,
        CPI_ACCT_INFO_SIZE_OF + offset_of!(SolAccountInfo, executable)
    );

    // CPI instruction data checks.
    assert_eq!(
        CPI_INSN_DATA_VARIANT_OFFSET,
        offset_of!(InstructionData, variant)
    );
    assert_eq!(
        CPI_INSN_DATA_AMOUNT_OFFSET,
        offset_of!(InstructionData, amount)
    );
    assert!(size_of::<InstructionData>().is_multiple_of(ALIGNMENT));
    assert_eq!(CPI_INSN_DATA_LEN, size_of::<u32>() + size_of::<u64>(),);

    // Stack offset checks.
    assert_eq!(STACK_ACCT_INFOS_OFFSET, 2 * size_of::<SolAccountInfo>());
    assert_eq!(
        STACK_ACCT_METAS_OFFSET,
        STACK_ACCT_INFOS_OFFSET + 2 * size_of::<SolAccountMeta>()
    );
    assert_eq!(
        STACK_INSN_DATA_OFFSET,
        STACK_ACCT_METAS_OFFSET + size_of::<InstructionData>()
    );
    assert_eq!(
        STACK_INSN_OFFSET,
        STACK_INSN_DATA_OFFSET + size_of::<SolInstruction>()
    );
    assert!(STACK_ACCT_INFOS_OFFSET.is_multiple_of(ALIGNMENT));
    assert!(STACK_ACCT_METAS_OFFSET.is_multiple_of(ALIGNMENT));
    assert!(STACK_INSN_DATA_OFFSET.is_multiple_of(ALIGNMENT));
    assert!(STACK_INSN_OFFSET.is_multiple_of(ALIGNMENT));
}